<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estetoscopio Electr√≥nico</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#283747" />
  <link rel="icon" type="image/png" sizes="192x192" href="images/logo-192.png" />
</head>
<body>
  <!-- Splash -->
  <div id="splash-screen">
    <video id="splash-video" autoplay muted playsinline>
      <source src="splash/splash.mp4" type="video/mp4">
      Tu navegador no soporta video.
    </video>
  </div>

  <!-- App principal -->
  <div id="app" class="hidden">
    <button id="btn-help" class="help-button">‚ùì</button>
    <header>
      <h1>ESTETOSCOPIO ELECTR√ìNICO</h1>
      <p>ETIR Pedro Le√≥n Torres ‚Ä¢ 4to Electromedicina</p>
    </header>
    <main id="screen-home">
      <div id="mic-warning" class="warning hidden">
        üîå <strong>Conecta el micr√≥fono externo</strong> antes de grabar.
      </div>
      <button id="btn-install" class="hidden">Instalar App</button>
      <button id="btn-record">Grabar</button>
      <button id="btn-exit">Salir</button>
    </main>
    <section id="screen-record" class="hidden">
      <h2>Grabando... (12s)</h2>
      <canvas id="waveform-live" width="760" height="300"></canvas>
    </section>
    <section id="screen-results" class="hidden">
      <h2>Resultados</h2>
      <canvas id="waveform-result" width="570" height="380"></canvas>
      <div id="times-list">
        <h3>TIEMPO (s)</h3>
        <ul id="time-values"></ul>
      </div>
      <div id="classification"></div>
      <button id="btn-export-pdf">Exportar PDF</button>
      <button id="btn-results-back">Atr√°s</button>
    </section>
  </div>

  <!-- Modal de ayuda -->
  <div id="help-modal" class="modal hidden">
    <div class="modal-content">
      <span id="close-help" class="close">&times;</span>
      <h2>Manual de Uso</h2>
      <p><strong>¬øQu√© es esta app?</strong><br>Convierte tu dispositivo en un estetoscopio electr√≥nico.</p>
      <p><strong>Requisitos:</strong><br>- Micr√≥fono externo (jack o USB)<br>- Navegador: Chrome, Edge o Firefox</p>
      <p><strong>Uso:</strong><br>1. Conecta micr√≥fono<br>2. Permite acceso al micr√≥fono<br>3. Toca "Grabar"<br>4. Espera 12s<br>5. Ver resultados</p>
      <p><strong>Diagn√≥stico:</strong><br>‚Ä¢ Normal: 60‚Äì100 lpm<br>‚Ä¢ Taquicardia: >100 lpm<br>‚Ä¢ Bradicardia: <60 lpm</p>
      <p><em>Esta app es una herramienta de apoyo. No sustituye evaluaci√≥n cl√≠nica profesional.</em></p>
    </div>
  </div>

  <!-- ‚úÖ Modal de permisos (con l√≥gica inline) -->
  <div id="permission-modal" class="modal hidden">
    <div class="modal-content">
      <h2>Permisos necesarios</h2>
      <p>Esta app requiere acceso al <strong>micr√≥fono</strong> para funcionar.</p>
      <p>Al tocar "Continuar", el navegador te pedir√° permiso. Por favor, <strong>perm√≠telo</strong>.</p>
      <button id="btn-permission-ok">Continuar</button>
    </div>
  </div>

  <script src="lib/tf.min.js"></script>
  <script src="lib/jspdf.umd.min.js"></script>
  <script src="app.js"></script>

  <!-- ‚úÖ L√≥gica cr√≠tica en l√≠nea: siempre funciona -->
  <script>
    // Cerrar modal de permisos
    document.getElementById('btn-permission-ok').onclick = function() {
      document.getElementById('permission-modal').classList.add('hidden');
      localStorage.setItem('stetos-permission-shown', 'true');
    };

    // Cerrar ayuda
    document.getElementById('close-help').onclick = function() {
      document.getElementById('help-modal').classList.add('hidden');
    };

    // Abrir ayuda
    document.getElementById('btn-help').onclick = function() {
      document.getElementById('help-modal').classList.remove('hidden');
    };

    // Forzar transici√≥n del splash tras 5.5s
    setTimeout(() => {
      const splash = document.getElementById('splash-screen');
      const app = document.getElementById('app');
      if (splash && app) {
        splash.classList.add('hidden');
        app.classList.remove('hidden');
        // Mostrar permisos si es la primera vez
        if (!localStorage.getItem('stetos-permission-shown')) {
          setTimeout(() => {
            const permModal = document.getElementById('permission-modal');
            if (permModal) permModal.classList.remove('hidden');
          }, 300);
        }
      }
    }, 5500);

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/stetos-pwa/sw.js');
      });
    }
  </script>
</body>
</html>
